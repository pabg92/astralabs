# Changelog - December 16, 2024

## Summary
Major improvements to redline/AI suggestion system, dashboard progress tracking, and deals page filtering.

---

## 1. Redline Diff System Merged (PR #47)

### Backend Changes
- **Model updated**: `gpt-5-nano` â†’ `gpt-4o-mini` for better availability/speed
- **Dual prompts**: Different AI prompts for PAT vs non-PAT context
- **Diff export**: Added `[-deleted-]` `[+added+]` markers to text exports
- **New function**: `formatDiffForExport()` in `/lib/diff-utils.ts`

### Frontend Changes
- **Generate AI Suggestion button**: Now shows on ALL clauses (not just PAT matches)
- **Dynamic help text**: Shows relevant context based on whether clause has PAT match
- **Duplicate close button fix**: Removed extra X from Suggested Redlines modal

### Files Modified
- `/app/api/reconciliation/[dealId]/redlines/generate/route.ts`
- `/app/api/reconciliation/[dealId]/export/route.ts`
- `/lib/diff-utils.ts`
- `/app/reconciliation/page.tsx`
- `/components/redlines/suggested-redlines-modal.tsx`

---

## 2. AI Suggest Button on Clause Cards

Added "AI Suggest" button to each clause card in the Cards view.

### Features
- Purple button with sparkles icon next to "Suggest change"
- Shows loading spinner while generating
- Opens Suggested Redlines modal when complete
- Uses same API as the right panel Generate button

### Files Modified
- `/app/reconciliation/page.tsx` - Added `handleGenerateSuggestionForClause()` function and button

---

## 3. Fixed Suggested Redlines Modal Not Opening

### Problem
Modal was conditionally rendered only when redlines existed, causing race condition after generating new suggestion.

### Solution
Changed from conditional rendering to always render modal, control visibility via `open` prop.

### Before
```tsx
{selectedClause && selectedClauseRedlines.length > 0 && (
  <SuggestedRedlinesModal open={modalOpen} ... />
)}
```

### After
```tsx
<SuggestedRedlinesModal
  open={modalOpen && !!selectedClause && selectedClauseRedlines.length > 0}
  ...
/>
```

### Files Modified
- `/app/reconciliation/page.tsx` (~line 3619)

---

## 4. Dashboard Progress Fix

### Problem
Recent Deals on dashboard showed 0% progress for all deals.

### Root Cause
Progress was calculated from `clause_reviews` table, but reconciliation uses `clause_match_results.rag_status = 'green'`.

### Solution
Changed progress calculation to count approved (green) clauses from `clause_match_results`.

### Files Modified
- `/app/api/dashboard/stats/route.ts`

---

## 5. Deals Page Filter Improvements

### Features Added
1. **Clickable summary cards** - Click Pending/Redlining/Approved/Signed to filter
2. **Toggle behavior** - Click same card again to clear filter
3. **Visual highlight** - Active card gets colored border + shadow
4. **Filter indicator** - "Showing X of Y deals" with active filter badge
5. **Clear all filters button** - One click to reset everything

### Removed
- Non-functional Category filter dropdown (was not connected to any logic)

### Files Modified
- `/app/deals/page.tsx`

---

## 6. Debug Logging Added (Kept for now)

Console logs added to trace AI suggestion flow:
- `[AI Suggest]` - Client-side button click and API call
- `[Redline Generate API]` - Server-side request handling

### Files with debug logs
- `/app/reconciliation/page.tsx` - `handleGenerateSuggestionForClause()`
- `/app/api/reconciliation/[dealId]/redlines/generate/route.ts`

---

## Commits (chronological)

1. `bec2e6f` - fix: Switch AI model to gpt-4o-mini and improve redline export
2. `f5dee3c` - fix: Show Generate AI Suggestion button for all clauses
3. `9cf7735` - fix: Remove duplicate close button from Suggested Redlines modal
4. `5e09266` - feat: Add AI Suggest button to clause cards view
5. `96ad936` - fix: Always render SuggestedRedlinesModal to fix popup not appearing
6. `f292fb8` - debug: Add logging to trace AI suggestion flow
7. `8e6e70e` - fix: Dashboard progress now matches reconciliation page
8. `c002a1c` - feat: Make deals summary cards clickable filters + cleanup

---

## Known Issues / Notes

- OpenAI API key on Vercel was returning 401 - resolved by regenerating and re-adding key
- Debug logs intentionally kept for future troubleshooting
